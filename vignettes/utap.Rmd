---
title: "utap"
output: 
  rmarkdown::html_vignette:
    df_print: tibble
vignette: >
  %\VignetteIndexEntry{utap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = " ",
  eval = TRUE
)
```

```{r pkgs, message=FALSE, warning=FALSE}
library(utap)
library(lobstr)
```

## Function trees

The `lobstr` package provides the abstract syntax tree function, which I like to use for creating function trees. For example, below is the tree for `pull_binary_cols()`:

```{r}
#| eval: true
#| echo: true
lobstr::ast(
  pull_binary_cols(
    select_class(
      is_class()
      ),
  make_binary_vec(
    check_binary_vec(
      check_log_binary(),
      check_int_binary(),
      check_chr_binary(),
      check_fct_binary(),
      check_ord_binary()
        )
      )
    )
  )
```

This function can be demonstrated using data with some of the test helpers in `tests/testthat/helper.R`

```{r}
#| message: false 
#| warning: false
# load testthat helpers
pkgload::load_all(helpers = TRUE)
```


```{r test_data}
#| eval: true
#| echo: true
test_data <- tibble::tibble(
  list_var = list(
    fct_vec = fct_maker(size = 3),
    ord_vec = ord_maker(size = 3),
    chr_vec = chr_maker(size = 3),
    log_vec = log_maker(size = 3),
    int_vec = int_maker(size = 3),
    dbl_vec = dbl_maker(size = 3)
  ),
  log_var = log_maker(size = 6, missing = TRUE),
  int_var = int_maker(size = 6, missing = TRUE),
  dbl_var = dbl_maker(size = 6, missing = TRUE),
  facet_var = cat_maker(
    facet_type = "fct",
    lvls = 4, missing = TRUE,
    size = 6
  ),
  bin_var = bin_maker(
    bin_type = "log",
    missing = TRUE, size = 6
  )
)
```

```{r}
#| eval: true
#| echo: true
test_data
```


### select_class() & is_class()

Both `select_class()` and `is_class()` are stored in `R/select_class.R`, which includes the `return_tbl` argument for returning the columns as a named vector. 

```{r}
#| eval: true
#| echo: true
lobstr::ast(
  select_class(
    is_class( # nested
    )
  )
)
```

```{r}
#| eval: true
#| echo: true
select_class(
  df = test_data,
  class = c("int", "dbl"),
  return_tbl = TRUE
)

select_class(
  df = test_data,
  class = c("int", "dbl"),
  return_tbl = FALSE
)
```




### pull_[type]_cols()

All of the `pull_[type]_cols()` functions use the `select_class()` to return the initial set of column names. See `pull_binary_cols()` and `pull_facet_cols()` below:

```{r}
#| eval: true
#| echo: true
lobstr::ast(
  pull_binary_cols(
    select_class(is_class()),
    make_binary_vec(
      check_binary_vec(
        check_log_binary(),
        check_int_binary(),
        check_chr_binary(),
        check_ord_binary()
      )
    )
  )
)
```

```{r}
pull_binary_cols(df = test_data)
```

```{r}
#| eval: true
#| echo: true
lobstr::ast(
    pull_facet_cols(
      pull_binary_cols(),
      select_class(is_class()),
      make_facet_vec(
        check_facet_vec(
          check_chr_facet(),
          check_fct_facet()
        )
      )
  )
)
```

```{r}
pull_facet_cols(df = test_data)
```

The full `pull_cols()` is outlined below: 

```{r}
#| eval: true
#| echo: true
#| code-fold: false
#| collapse: false
lobstr::ast(
  pull_cols(
    pull_binary_cols(
      select_class(is_class()),
      make_binary_vec(
        check_binary_vec(
          check_log_binary(),
          check_int_binary(),
          check_chr_binary(),
          check_ord_binary()
        )
      )
    ),
    pull_cat_cols(
      select_class(is_class())
    ),
    pull_facet_cols(
      pull_binary_cols(),
      select_class(is_class()),
      make_facet_vec(
        check_facet_vec(
          check_chr_facet(),
          check_fct_facet()
        )
      )
    ),
    pull_numeric_cols(
      pull_binary_cols(),
      pull_facet_cols()
    )
  )
)
```
